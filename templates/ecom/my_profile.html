{% extends 'ecom/customer_base.html' %}
{% load widget_tweaks %}
{% load static %}
{% block content %}

<style>
  /* Simplified, clean profile layout */
  .page-wrap { max-width: 1180px; margin: 44px auto; padding: 0 18px; }
  .profile-grid { display: grid; grid-template-columns: 280px 1fr; gap: 22px; }
  .sidebar { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
  .sidebar-title { font-weight:700; color:#374151; font-size:1.12rem; margin-bottom:10px; }
  .side-link { display:block; padding:12px 14px; border-radius:8px; color:#374151; text-decoration:none; font-weight:600; font-size:1.15rem; }
  .side-link:hover { background:#f3f4f6; }

  .content-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
  .content-head { padding:20px 20px 14px 20px; border-bottom:1px solid #e5e7eb; }
  .content-title { font-size:1.5rem; font-weight:700; color:#111827; }
  .content-sub { color:#6b7280; font-size:1.12rem; }
  .content-body { padding:20px; }

  .form-grid { display:grid; grid-template-columns: 1fr 360px; gap:22px; }
  .form-group { margin-bottom:16px; position:relative; }
  .form-group .input-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#9ca3af; font-size:1.1rem; }
  .form-control { width:100%; border:1px solid #d1d5db; border-radius:12px; padding:12px 14px 12px 42px; background:#f9fafb; font-size:1.12rem; }
  .form-control::placeholder { font-size:1.08rem; }
  .form-control:focus { outline:none; border-color:#2563eb; background:#fff; }
  .actions { display:flex; gap:12px; margin-top:12px; }
  .btn-primary { background:#2563eb; color:#fff; padding:12px 20px; border:none; border-radius:10px; font-weight:700; }
  .btn-secondary { background:#6b7280; color:#fff; padding:10px 16px; border:none; border-radius:10px; font-weight:600; text-decoration:none; }
  .avatar-box { border:1px dashed #d1d5db; border-radius:12px; padding:18px; text-align:center; }
  .avatar { width:140px; height:140px; border-radius:50%; object-fit:cover; background:#e5e7eb; display:inline-block; }
  .hint { color:#6b7280; font-size:1.02rem; margin-top:6px; }

  /* Style native file input button for better visibility */
  input[type="file"] { font-size:1.02rem; }
  input[type="file"]::file-selector-button { padding:10px 14px; border-radius:8px; background:#6b7280; color:#fff; border:none; font-weight:600; cursor:pointer; }
  input[type="file"]::-webkit-file-upload-button { padding:10px 14px; border-radius:8px; background:#6b7280; color:#fff; border:none; font-weight:600; cursor:pointer; }

  @media (max-width: 900px) { .form-grid { grid-template-columns:1fr; } }
</style>

<div class="page-wrap">
  <div class="profile-grid">
    <!-- Left sidebar: keep it minimal; exclude specified items -->
    <aside class="sidebar">
      <div class="sidebar-title">My Account</div>
      <a href="#" class="side-link" data-tab="profile">Profile</a>
      <a href="#" class="side-link" data-tab="addresses">Addresses</a>
      <a href="#" class="side-link" data-tab="password">Change Password</a>
      <a href="#" class="side-link" data-tab="orders">My Orders</a>
    </aside>

    <!-- Editable profile content -->
    <div class="content-card">
      <div class="content-head">
        <div class="content-title">My Profile</div>
        <div class="content-sub">Manage and protect your account</div>
      </div>
      <div class="content-body">
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-success" style="margin-bottom:10px;">{{ message }}</div>
          {% endfor %}
        {% endif %}
        <div id="tab-content">
          <div id="profile-pane">
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="form-grid">
                <div>
                  <div class="form-group">
                    <span class="input-icon"><i class="fa fa-user"></i></span>
                    {% render_field userForm.username class="form-control" placeholder="Username" %}
                  </div>
                  <div class="form-group">
                    <span class="input-icon"><i class="fa fa-id-card"></i></span>
                    {% render_field userForm.first_name class="form-control" placeholder="First Name" %}
                  </div>
                  <div class="form-group">
                    <span class="input-icon"><i class="fa fa-id-card"></i></span>
                    {% render_field userForm.last_name class="form-control" placeholder="Last Name" %}
                  </div>
                  <div class="form-group">
                    <span class="input-icon"><i class="fa fa-envelope"></i></span>
                    {% render_field userForm.email class="form-control" placeholder="Email" %}
                  </div>
                  <div class="form-group">
                    <span class="input-icon"><i class="fa fa-phone"></i></span>
                    {% render_field customerForm.mobile class="form-control" id="mobile_number" placeholder="956 837 0169" maxlength="13" minlength="13" pattern="^\d{3} \d{3} \d{4}$" oninput="autoFormatPHMobile(this)" %}
                  </div>
                  <div class="actions">
                    <button type="submit" class="btn-primary">Save</button>
                  </div>
                </div>
                <div>
                  <div class="avatar-box">
                    {% if customer.profile_pic %}
                      <img src="{{ customer.profile_pic.url }}" alt="Avatar" class="avatar" />
                    {% else %}
                      <div class="avatar"></div>
                    {% endif %}
                    <div style="margin-top:10px;">
                      {% render_field customerForm.profile_pic class="btn-secondary" %}
                    </div>
                    <div class="hint">File size: max 1 MB • JPG/PNG</div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>

        <script src="{% static 'ecom/ph-address-cascade.js' %}"></script>
        <script>
        function autoFormatPHMobile(input) {
          let digits = input.value.replace(/\D/g, '');
          if (digits.length > 3 && digits.length <= 6)
              input.value = digits.slice(0,3) + ' ' + digits.slice(3);
          else if (digits.length > 6)
              input.value = digits.slice(0,3) + ' ' + digits.slice(3,6) + ' ' + digits.slice(6,10);
          else
              input.value = digits;
        }

        const tabContent = document.getElementById('tab-content');
        const profileHTML = document.getElementById('profile-pane').outerHTML;
        const urls = {
          addresses: '{% url "addresses-tab" %}',
          password: '{% url "change-password" %}',
          orders: '{% url "my-order" %}'
        };

        function setActive(link){
          document.querySelectorAll('.side-link').forEach(a=>a.style.background='');
          link.style.background = '#f3f4f6';
        }

        let currentTab = 'profile';
        let currentLink = null;

        async function loadTab(tab, linkEl){
          setActive(linkEl);
          currentTab = tab; currentLink = linkEl;
          if (tab === 'profile') {
            tabContent.innerHTML = profileHTML;
            return;
          }
          const url = urls[tab];
          if (!url) return;
          tabContent.innerHTML = '<div style="padding:10px; color:#6b7280;">Loading…</div>';
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const html = await res.text();
            // Inject HTML
            tabContent.innerHTML = html;
            // Execute scripts contained in the loaded fragment safely
            const scripts = tabContent.querySelectorAll('script');
            scripts.forEach(orig => {
              if (orig.src) {
                // Avoid loading duplicate external scripts
                if (!document.querySelector(`script[src="${orig.src}"]`)) {
                  const s = document.createElement('script');
                  s.src = orig.src;
                  s.async = false;
                  if (orig.type) s.type = orig.type;
                  document.body.appendChild(s);
                }
              } else {
                // Run inline scripts in an isolated scope to prevent const/let redeclaration errors
                const code = orig.textContent || '';
                try {
                  new Function(`(function(){\n${code}\n})();`)();
                } catch (err) {
                  console.error('Fragment inline script error:', err);
                }
              }
              // Remove original to avoid duplicate execution on future reloads
              orig.parentNode && orig.parentNode.removeChild(orig);
            });
          } catch (e) {
            tabContent.innerHTML = '<div style="padding:10px; color:#ef4444;">Failed to load content.</div>';
          }
        }

        document.querySelectorAll('.side-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const tab = link.getAttribute('data-tab');
            loadTab(tab, link);
          });
        });
        // Allow child fragment to trigger reload of addresses tab
        window.addEventListener('reload-addresses-tab', function(){
          const addressesLink = document.querySelector('.side-link[data-tab="addresses"]');
          const linkEl = addressesLink || currentLink || document.querySelector('.side-link[data-tab="profile"]');
          loadTab('addresses', linkEl);
        });
        // Default active tab: profile
        const defaultLink = document.querySelector('.side-link[data-tab="profile"]');
        if (defaultLink) setActive(defaultLink);
        </script>
        <style>
          /* Scoped scaling for My Profile page */
          :where(#tab-content) { font-size: 1.2rem !important; line-height: 1.7; }
          .content-card { font-size: 1.15rem; }
          .side-link { font-size: 1.15rem !important; padding: 10px 12px; }
          .avatar { width: 110px; height: 110px; }
          .section-title, .page-header h2, .page-header h1 { font-size: 1.35rem; }
          /* Inputs inside profile forms */
          input, select, textarea { font-size: 1.15rem !important; }
          input::placeholder, textarea::placeholder { font-size: 1.12rem !important; }
          label { font-size: 1.15rem !important; }
          .btn, .btn-primary, .btn-secondary { font-size: inherit; }
        </style>
      </div>
    </div>
  </div>
</div>

{% endblock content %}
