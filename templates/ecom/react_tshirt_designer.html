{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GearCraftWorks | T-Shirt Designer</title>
    
    <!-- React T-Shirt Designer CSS -->
    <link rel="stylesheet" crossorigin href="{% static 'react-designer/assets/index-BI4ji8F3.css' %}">
    
    <!-- Bootstrap for navbar consistency -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Override any development-specific styles */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #root {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div class="flex flex-col h-screen">
        <!-- Navigation -->
        <nav class="bg-gray-900">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <div class="text-white text-xl font-bold">GearCraftWorks</div>
                    <div class="flex space-x-4">
                        <a href="{% url 'home' %}" class="text-gray-300 hover:text-white px-3 py-2">Home</a>
                        <a href="{% url 'customizer' %}" class="text-gray-300 hover:text-white px-3 py-2">3D Designer</a>
                        <a href="{% url 'react_tshirt_designer' %}" class="text-white px-3 py-2">T-Shirt Designer</a>
                        <a href="{% url 'about' %}" class="text-gray-300 hover:text-white px-3 py-2">About Us</a>
                        {% if user.is_authenticated %}
                            <a href="{% url 'logout' %}" class="text-gray-300 hover:text-white px-3 py-2">Logout</a>
                        {% else %}
                            <a href="{% url 'customerlogin' %}" class="text-gray-300 hover:text-white px-3 py-2">Login</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>

        <!-- React App Container -->
        <div id="root" class="flex-1"></div>
    </div>

    <!-- Custom integration script - MUST be loaded before React app -->
    <script>
        // Set up Django configuration for React
        window.DJANGO_CONFIG = {
            staticUrl: '{% get_static_prefix %}',
            csrfToken: '{{ csrf_token }}'
        };
        
        // Set base path for React assets
        window.__PUBLIC_PATH__ = '{% get_static_prefix %}react-designer/';
        window.__REACT_DESIGNER_BASE_PATH__ = '{% get_static_prefix %}react-designer/';
        
        // Disable Vite client in production
        window.__vite_is_modern_browser = false;
        window.importMeta = { env: { PROD: true } };
        
        console.log('Setting up request interception...');
        
        // Override XMLHttpRequest and fetch to redirect 3D model requests
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            console.log('Fetch called with URL:', url);
            if (typeof url === 'string' && (url.includes('3Dmodels/') || url.includes('.glb'))) {
                console.log('Intercepting fetch request:', url);
                // Handle both absolute and relative paths that resolve to current page
                if (url.includes('/react-tshirt-designer/3Dmodels/')) {
                    const filename = url.split('/').pop();
                    const modelPath = url.includes('textures/') ? 
                        '3Dmodels/textures/' + filename : 
                        '3Dmodels/' + filename;
                    url = '{% get_static_prefix %}react-designer/' + modelPath;
                } else if (url.includes('3Dmodels/')) {
                    const filename = url.split('/').pop();
                    const modelPath = url.includes('textures/') ? 
                        '3Dmodels/textures/' + filename : 
                        '3Dmodels/' + filename;
                    url = '{% get_static_prefix %}react-designer/' + modelPath;
                }
                console.log('Redirected to:', url);
            }
            return originalFetch.call(this, url, options);
        };

        // Also override XMLHttpRequest for Three.js loaders
        const originalXHROpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...args) {
            console.log('XHR open called with URL:', url);
            if (typeof url === 'string' && (url.includes('3Dmodels/') || url.includes('.glb'))) {
                console.log('Intercepting XHR request:', url);
                if (url.includes('/react-tshirt-designer/3Dmodels/')) {
                    const filename = url.split('/').pop();
                    const modelPath = url.includes('textures/') ? 
                        '3Dmodels/textures/' + filename : 
                        '3Dmodels/' + filename;
                    url = '{% get_static_prefix %}react-designer/' + modelPath;
                } else if (url.includes('3Dmodels/')) {
                    const filename = url.split('/').pop();
                    const modelPath = url.includes('textures/') ? 
                        '3Dmodels/textures/' + filename : 
                        '3Dmodels/' + filename;
                    url = '{% get_static_prefix %}react-designer/' + modelPath;
                }
                console.log('XHR Redirected to:', url);
            }
            return originalXHROpen.call(this, method, url, ...args);
        };

        // Wait for React to load, then override Three.js loaders
        setTimeout(() => {
            console.log('Checking for THREE.js...');
            if (window.THREE && window.THREE.FileLoader) {
                console.log('THREE.js found, setting up FileLoader override...');
                const originalLoad = window.THREE.FileLoader.prototype.load;
                window.THREE.FileLoader.prototype.load = function(url, onLoad, onProgress, onError) {
                    console.log('THREE.FileLoader load called with URL:', url);
                    if (typeof url === 'string' && (url.includes('3Dmodels/') || url.includes('.glb'))) {
                        console.log('Intercepting THREE.FileLoader request:', url);
                        if (url.includes('/react-tshirt-designer/3Dmodels/')) {
                            const filename = url.split('/').pop();
                            const modelPath = url.includes('textures/') ? 
                                '3Dmodels/textures/' + filename : 
                                '3Dmodels/' + filename;
                            url = '{% get_static_prefix %}react-designer/' + modelPath;
                        } else if (url.includes('3Dmodels/')) {
                            const filename = url.split('/').pop();
                            const modelPath = url.includes('textures/') ? 
                                '3Dmodels/textures/' + filename : 
                                '3Dmodels/' + filename;
                            url = '{% get_static_prefix %}react-designer/' + modelPath;
                        }
                        console.log('THREE.FileLoader Redirected to:', url);
                    }
                    return originalLoad.call(this, url, onLoad, onProgress, onError);
                };
            } else {
                console.log('THREE.js not found yet, will try again...');
                setTimeout(arguments.callee, 1000);
            }
        }, 1000);
    </script>
    
    <!-- React T-Shirt Designer JavaScript -->
    <script type="module" crossorigin src="{% static 'react-designer/assets/index-C-KKdc0q.js' %}?v={{ request.GET.ide_webview_request_time|default:'1' }}"></script>
</body>
</html>