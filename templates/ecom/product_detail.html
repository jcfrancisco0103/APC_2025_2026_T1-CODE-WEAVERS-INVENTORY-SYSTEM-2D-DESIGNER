{% extends 'ecom/customer_base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Product Image -->
        <div class="col-md-6">
            <div class="product-image-container">
                {% if product.product_image %}
                    <img src="{{ product.product_image.url }}" alt="{{ product.name }}" class="img-fluid rounded shadow">
                {% else %}
                    <img src="{% static 'images/default-product.jpg' %}" alt="{{ product.name }}" class="img-fluid rounded shadow">
                {% endif %}
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-md-6">
            <div class="product-details">
                <h1 class="product-title">{{ product.name }}</h1>

                
                <!-- Rating Display -->
                {% if avg_rating %}
                <div class="rating-display mb-3">
                    <div class="stars">
                        {% for i in "12345" %}
                            {% if forloop.counter <= avg_rating %}
                                <i class="fas fa-star text-warning"></i>
                            {% else %}
                                <i class="far fa-star text-warning"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="rating-text">{{ avg_rating }}/5 ({{ review_count }} reviews)</span>
                </div>
                {% endif %}

                <h3 class="product-price text-primary">₱{{ product.price }}</h3>
                
                <div class="product-description mt-3">
                    <h5>Description:</h5>
                    <p>{{ product.description|default:"No description available." }}</p>
                </div>

                <!-- Add to Cart Form (hidden in review mode) -->
                {% if not review_mode %}
                <form method="post" action="{% url 'add-to-cart' product.id %}" class="mt-4">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <label for="size" class="form-label">Select Size:</label>
                            <select name="size" class="form-select" required>
                                <option value="S">Small</option>
                                <option value="M">Medium</option>
                                <option value="L">Large</option>
                                <option value="XL">Extra Large</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="quantity" class="form-label">Quantity:</label>
                            <input type="number" name="quantity" value="1" min="1" max="10" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary btn-lg me-2">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                        
                        <!-- Wishlist Button -->
                        {% if user.is_authenticated %}
                        <button type="button" class="btn btn-outline-danger" id="wishlist-btn" data-product-id="{{ product.id }}">
                            {% if in_wishlist %}
                                <i class="fas fa-heart"></i> Remove from Wishlist
                            {% else %}
                                <i class="far fa-heart"></i> Add to Wishlist
                            {% endif %}
                        </button>
                        {% endif %}
                    </div>
                </form>
                {% else %}
                <div class="alert alert-secondary mt-4" role="alert">
                    You’re reviewing your purchase.
                    {% if purchased_size %}
                        <strong>Size:</strong> {{ purchased_size }}
                    {% endif %}
                    {% if purchased_quantity %}
                        <strong class="ms-3">Quantity:</strong> {{ purchased_quantity }}
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Product Reviews Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3>Customer Reviews</h3>
            
            <!-- Add Review Form (for authenticated users who purchased the product) -->
            {% if user.is_authenticated and can_review %}
            <div class="add-review-section mb-4">
                <h5>Write a Review</h5>
                <form id="review-form" data-product-id="{{ product.id }}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Rating:</label>
                        <div class="rating-input">
                            {% for i in "12345" %}
                            <input type="radio" name="rating" value="{{ forloop.counter }}" id="star{{ forloop.counter }}" required>
                            <label for="star{{ forloop.counter }}" class="star-label">
                                <i class="far fa-star"></i>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="review_text" class="form-label">Review:</label>
                        <textarea name="review_text" id="review_text" class="form-control" rows="4" placeholder="Share your experience with this product..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Submit Review</button>
                </form>
            </div>
            {% elif user.is_authenticated %}
            <div class="alert alert-info" role="alert">
                You can rate and comment after your order for this product is delivered.
            </div>
            {% endif %}

            <!-- Display Reviews -->
            <div class="reviews-list">
                {% for review in reviews %}
                <div class="review-item border-bottom pb-3 mb-3">
                    <div class="review-header d-flex justify-content-between">
                        <div>
                            <strong>{{ review.customer.user.first_name }} {{ review.customer.user.last_name }}</strong>
                            <div class="review-rating">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                    </div>
                    {% if review.review_text %}
                    <p class="review-text mt-2">{{ review.review_text }}</p>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-muted">No reviews yet. Be the first to review this product!</p>
                {% endfor %}
            </div>
        </div>
    </div>

    
</div>

<style>
.product-image-container img {
    max-height: 500px;
    object-fit: cover;
}

.rating-input {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
}

.rating-input input[type="radio"] {
    display: none;
}

.star-label {
    cursor: pointer;
    font-size: 1.5rem;
    color: #ddd;
    transition: color 0.2s;
}

.rating-input input[type="radio"]:checked ~ .star-label,
.rating-input input[type="radio"]:hover ~ .star-label,
.star-label:hover {
    color: #ffc107;
}

.rating-input .star-label:hover ~ .star-label {
    color: #ffc107;
}

.review-item {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}
</style>

<script>
// Wishlist functionality
document.addEventListener('DOMContentLoaded', function() {
    const wishlistBtn = document.getElementById('wishlist-btn');
    if (wishlistBtn) {
        wishlistBtn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const isInWishlist = this.innerHTML.includes('fas fa-heart');
            const url = isInWishlist ? 
                `/remove-from-wishlist/${productId}/` : 
                `/add-to-wishlist/${productId}/`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isInWishlist) {
                        this.innerHTML = '<i class="far fa-heart"></i> Add to Wishlist';
                        this.classList.remove('btn-danger');
                        this.classList.add('btn-outline-danger');
                    } else {
                        this.innerHTML = '<i class="fas fa-heart"></i> Remove from Wishlist';
                        this.classList.remove('btn-outline-danger');
                        this.classList.add('btn-danger');
                    }
                }
                // Show message (you can implement a toast notification here)
                console.log(data.message);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }

    // (Removed) Related products wishlist functionality

    // Review form submission
    const reviewForm = document.getElementById('review-form');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const productId = this.dataset.productId;
            
            fetch(`/add-review/${productId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    location.reload(); // Reload to show the new review
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting your review.');
            });
        });
    }
});
</script>
{% endblock %}
